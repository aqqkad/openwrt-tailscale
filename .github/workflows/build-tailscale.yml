name: Smaller Tailscale Build Pipeline

on:
  schedule:
    - cron: '30 0/12 * * *'
  workflow_dispatch:

env:
  SOFTWARE_NAME: "Tailscale"
  FILE_NAME: "tailscaled"
  REPO: "tailscale/tailscale"
  REPO_SMALL: "GuNanOvO/openwrt-tailscale"
  REPO_SMALL_NAME: "openwrt-tailscale"
  REPO_SMALL_OWNER: "GuNanOvO"
  ARTIFACT_DIR: "artifacts"
  BUILD_DATE: ""
jobs:
  version-check:
    name: Check Version Differences
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.compare.outputs.should_build }}
      upstream_tag: ${{ steps.get_upstream.outputs.tag }}
    steps:
      - name: Get latest stable tag from tailscale
        id: get_upstream
        uses: actions/github-script@v6
        with:
          script: |
            const { data: tags } = await github.rest.repos.listTags({
              owner: 'tailscale',
              repo: 'tailscale',
              per_page: 100
            });

            const stableTags = tags
              .map(tag => tag.name)
              .filter(name => /^v\d+\.\d+\.\d+$/.test(name));

            stableTags.sort((a, b) => {
              const parse = v => v.slice(1).split('.').map(Number);
              const [a1, a2, a3] = parse(a);
              const [b1, b2, b3] = parse(b);
              return b1 - a1 || b2 - a2 || b3 - a3;
            });

            const latest = stableTags[0] || '';
            core.setOutput('tag', latest);

      - name: Get latest release tag from openwrt-tailscale
        id: get_small
        uses: actions/github-script@v6
        with:
          script: |
            try {
              const { data } = await github.rest.repos.getLatestRelease({
                owner: 'GuNanOvO',
                repo: 'openwrt-tailscale'
              });
              core.setOutput('tag', data?.tag_name || '');
            } catch (error) {
              core.setOutput('tag', '');
            }

      - name: Compare versions
        id: compare
        run: |
          echo "Upstream: ${{ steps.get_upstream.outputs.tag }}"
          echo "Local: ${{ steps.get_small.outputs.tag }}"
          if [ "${{ steps.get_upstream.outputs.tag }}" != "${{ steps.get_small.outputs.tag }}" ]; then
            echo "should_build=true" >> ${GITHUB_OUTPUT}
          else
            echo "should_build=false" >> ${GITHUB_OUTPUT}
          fi

  build:
    name: Build for ${{ matrix.platform.id }}
    needs: version-check
    if: needs.version-check.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform: [
          {
            id: 'arm',
            goarch: 'arm',
            openwrt_targets: 
              [
              'arm_arm1176jzf-s_vfp',
              'arm_arm926ej-s',
              'arm_cortex-a15_neon-vfpv4',
              'arm_cortex-a5_vfpv4',
              'arm_cortex-a7',
              'arm_cortex-a7_neon-vfpv4',
              'arm_cortex-a7_vfpv4',
              'arm_cortex-a8_vfpv3',
              'arm_cortex-a9',
              'arm_cortex-a9_neon',
              'arm_cortex-a9_vfpv3-d16',
              'arm_fa526',
              'arm_xscale',
              'arm_mpcore'
            ]
          },
          {
            id: 'arm64',
            goarch: 'arm64',
            openwrt_targets: [
              'aarch64_cortex-a53',
              'aarch64_cortex-a72',
              'aarch64_cortex-a76',
              'aarch64_generic'
            ]
          },
          {
            id: 'mips',
            goarch: 'mips',
            gomips: 'softfloat',
            openwrt_targets: [
              'mips_24kc',
              'mips_4kec',
              'mips_mips32'
            ]
          },
          {
            id: 'mipsle',
            goarch: 'mipsle',
            gomips: 'softfloat',
            openwrt_targets: [
              'mipsel_24kc',
              'mipsel_24kc_24kf',
              'mipsel_74kc',
              'mipsel_mips32'
            ]
          },
          {
            id: 'mips64',
            goarch: 'mips64',
            gomips: 'softfloat',
            openwrt_targets: [
              'mips64_mips64r2',
              'mips64_octeonplus'
            ]
          },
          {
            id: 'mips64le',
            goarch: 'mips64le',
            gomips: 'softfloat',
            openwrt_targets: [
              'mips64el_mips64r2'
            ]
          },
          {
            id: '386',
            goarch: '386',
            openwrt_targets: [
              'i386_pentium-mmx',
              'i386_pentium4'
            ]
          },
          {
            id: 'amd64',
            goarch: 'amd64',
            cgo_enabled: '1',
            cc: 'musl-gcc',
            setup: 'sudo apt-get update && sudo apt-get install -y musl-tools',
            openwrt_targets: [
              'x86_64'
            ]
          },
          {
            id: 'geode',
            goarch: '386',
            go386: 'softfloat',
            openwrt_targets: [
              'i386_pentium-mmx',
              'i386_pentium4'
            ]
          }
        ]

      fail-fast: false

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          repository: ${{ env.REPO }}
          ref: ${{ needs.version-check.outputs.upstream_tag }}
          path: src

      - name: Checkout packaging files
        uses: actions/checkout@v4
        with:
          path: packaging

      - name: Setup build environment
        run: |
          ${{ matrix.platform.setup || 'echo "No additional setup required"' }}
          
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: stable
          cache: true
          cache-dependency-path: src/go.sum

      - name: Setup UPX
        uses: crazy-max/ghaction-upx@v2
        with:
          version: latest

      - name: Build binary
        working-directory: ./src
        env:
          GOOS: linux
          GOARCH: ${{ matrix.platform.goarch }}
          GOMIPS: ${{ matrix.platform.gomips || '' }}
          GO386: ${{ matrix.platform.go386 || '' }}
          CGO_ENABLED: ${{ matrix.platform.cgo_enabled || 0 }}
          CC: ${{ matrix.platform.cc || '' }}
        run: |
          output_name="${{ env.FILE_NAME }}-linux-${{ matrix.platform.id }}"
          mkdir -p ../build
          ./build_dist.sh \
            --extra-small --box \
            -o "../build/${output_name}" \
            ./cmd/${{ env.FILE_NAME }}
          
          # Verify the binary was created
          if [ ! -f "../build/${output_name}" ]; then
            echo "::error::Build failed for ${{ matrix.platform.id }}"
            exit 1
          fi

      - name: Process binary
        run: |
          # Process binary
          mkdir -p compressed "${{ env.ARTIFACT_DIR }}"
          filename="${{ env.FILE_NAME }}-linux-${{ matrix.platform.id }}"
          file="build/${filename}"
          chmod -v +x "${file}"
          # Create uncompressed copy
          cp -p "${file}" "compressed/${filename}-normal"
          cp -p "${file}" "${{ env.ARTIFACT_DIR }}/${filename}-normal"
          # Skip unsupported platforms
          if [[ "${filename}" =~ (mips64|mips64le) ]]; then
            echo "Skipping UPX for ${filename}"
          else
            # Compress with UPX
            upx --lzma --best --no-progress "${file}" -o "compressed/${filename}"
            cp -p "compressed/${filename}" "${{ env.ARTIFACT_DIR }}/${filename}"
          fi

      - name: Package IPK
        run: |
          EPOCH=$(date +%s)
          mkdir -p ipk/usr/bin ipk/etc ipk/lib ipk/CONTROL
          for bin in compressed/${{ env.FILE_NAME }}-linux-${{ matrix.platform.id }}*; do
            basebin=$(basename "${bin}")

            if [[ "${basebin}" =~ -normal$ ]]; then
              normal_bin="${basebin}"
            else
              compressed_bin="${basebin}"
            fi

            install -m 0755 "${bin}" ipk/usr/bin/tailscaled
            ln -svf tailscaled ipk/usr/bin/tailscale || true
            SIZE=$(du -sb ipk/usr/bin | awk '{print $1}')

            cp -a packaging/etc/* ipk/etc/
            cp -a packaging/lib/* ipk/lib/
            cp -a packaging/CONTROL/* ipk/CONTROL/

            chmod +x ipk/etc/init.d/tailscale || true
            echo '2.0' > debian-binary

            targets_json='${{ toJson(matrix.platform.openwrt_targets) }}'
            targets=$(echo "${targets_json}" | jq -r '.[]')

            for target in ${targets}; do
              ARCH=${target}
              VERSION=$(echo "${{ needs.version-check.outputs.upstream_tag }}" | sed 's/^v//')

              if [[ -z "$compressed_bin" ]]; then
                ipk_compressed="tailscale_${VERSION}_${ARCH}_normal.ipk"
              else
                ipk_compressed="tailscale_${VERSION}_${ARCH}.ipk"
              fi
              ipk_normal="tailscale_${VERSION}_${ARCH}_normal.ipk"

              sed -e "s/__VERSION__/${VERSION}/" \
                  -e "s/__ARCH__/${ARCH}/" \
                  -e "s/__SIZE__/${SIZE}/" \
                  -e "s/__EPOCH__/${EPOCH}/" \
                  packaging/CONTROL/control > ipk/CONTROL/control

              VERSION=${{ needs.version-check.outputs.upstream_tag }}
              tar --format=gnu --numeric-owner --group=0 --owner=0 -czf control.tar.gz -C ipk/CONTROL .
              tar --format=gnu --numeric-owner --group=0 --owner=0 -czf data.tar.gz -C ipk ./usr ./etc ./lib
              if [[ "${bin}" =~ (normal) ]]; then
                tar --format=gnu --numeric-owner --group=0 --owner=0 -cvzf ${{ env.ARTIFACT_DIR }}/tailscale_${VERSION}_${ARCH}_normal.ipk control.tar.gz data.tar.gz debian-binary
                echo "Created IPK: tailscale_${VERSION}_${ARCH}_normal.ipk"
              else
                tar --format=gnu --numeric-owner --group=0 --owner=0 -cvzf ${{ env.ARTIFACT_DIR }}/tailscale_${VERSION}_${ARCH}.ipk control.tar.gz data.tar.gz debian-binary
                echo "Created IPK: tailscale_${VERSION}_${ARCH}.ipk"
              fi

              rm -f control.tar.gz data.tar.gz

            done
            rm -f ipk/usr/bin/*

          done
          
          targets_json='${{ toJson(matrix.platform.openwrt_targets) }}'
          targets=$(echo "${targets_json}" | jq -r '.[]')

          : > ${{ env.ARTIFACT_DIR }}/artifacts.json.tmp

          for target in ${targets}; do
            ARCH=${target}
            VERSION=${{ needs.version-check.outputs.upstream_tag }}

            if [[ "${{ matrix.platform.id }}" =~ ^mips64 ]]; then
              binary_compressed="${{ env.FILE_NAME }}-linux-${{ matrix.platform.id }}-normal"
              ipk_compressed="tailscale_${VERSION}_${ARCH}_normal.ipk"
              elif [[ "${{ matrix.platform.id }}" =~ ^mips64le ]]; then
              binary_compressed="${{ env.FILE_NAME }}-linux-${{ matrix.platform.id }}-normal"
              ipk_compressed="tailscale_${VERSION}_${ARCH}_normal.ipk"
              else
              binary_compressed="${{ env.FILE_NAME }}-linux-${{ matrix.platform.id }}"
              ipk_compressed="tailscale_${VERSION}_${ARCH}.ipk"
            fi

            binary_normal="${{ env.FILE_NAME }}-linux-${{ matrix.platform.id }}-normal"
            ipk_normal="tailscale_${VERSION}_${ARCH}_normal.ipk"

            [ -f "${{ env.ARTIFACT_DIR }}/${binary_compressed}" ] || binary_compressed=""
            [ -f "${{ env.ARTIFACT_DIR }}/${binary_normal}" ] || binary_normal=""
            [ -f "${{ env.ARTIFACT_DIR }}/${ipk_compressed}" ] || ipk_compressed=""
            [ -f "${{ env.ARTIFACT_DIR }}/${ipk_normal}" ] || ipk_normal=""

            echo "{\"target\":\"${ARCH}\",\"binary_compressed\":\"${binary_compressed}\",\"binary_normal\":\"${binary_normal}\",\"ipk_compressed\":\"${ipk_compressed}\",\"ipk_normal\":\"${ipk_normal}\"}," >> ${{ env.ARTIFACT_DIR }}/artifacts.json.tmp
          done

          {
            echo "["
            sed '$ s/,$//' ${{ env.ARTIFACT_DIR }}/artifacts.json.tmp
            echo "]"
          } > ${{ env.ARTIFACT_DIR }}/artifacts-${{ matrix.platform.id }}.json

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.FILE_NAME }}-linux-${{ matrix.platform.id }}
          path: ${{ env.ARTIFACT_DIR }}/*

  release:
    name: Create Release
    needs: [version-check, build]
    if: needs.version-check.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    env:
      RELEASE_TAG: ${{ needs.version-check.outputs.upstream_tag }}
    steps:
      - name: Prepare workspace
        run: |
          mkdir -p ${{ env.ARTIFACT_DIR }}

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: ${{ env.ARTIFACT_DIR }}
          merge-multiple: true

      - name: Generate release files
        run: |
          echo "BUILD_DATE=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_ENV
          jq -s 'add' ${{ env.ARTIFACT_DIR }}/artifacts-*.json > ${{ env.ARTIFACT_DIR }}/artifacts.json
          rm -rf ${{ env.ARTIFACT_DIR }}/artifacts-*.json
          rm -rf ${{ env.ARTIFACT_DIR }}/artifacts.json.tmp
          # Create checksums
          cd ${{ env.ARTIFACT_DIR }}
          sha256sum * > checksums.txt
          
          # Create info file
          {
            echo "Version: ${{ env.RELEASE_TAG }}"
            echo "Build date: ${{ env.BUILD_DATE }}"
            echo ""
            echo "File sizes:"
            for file in ${{ env.FILE_NAME }}-*; do
              size=$(stat -c %s "${file}")
              echo "${file} ${size} bytes"
            done
          } > build-info.txt
          cd ..
      
      - name: Checkout feed branch
        uses: actions/checkout@v4
        with:
          ref: feed
          path: feed

      - name: Clone opkg-utils from Yocto
        run: git clone --depth 1 git://git.yoctoproject.org/opkg-utils || echo "Clone failed"

      - name: Prepare feed files
        run: |
          rm -rf feed/tailscale* feed/Packages* feed/version*
                
          jq -r '
            .[] | select(.ipk_compressed != "") | .ipk_compressed
          ' "${{ env.ARTIFACT_DIR }}/artifacts.json" | while read -r file; do
            cp "${{ env.ARTIFACT_DIR }}/${file}" feed/
          done

          opkg-utils/opkg-make-index -a -f -v --checksum sha256 -v /feed > feed/Packages
          gzip --keep feed/Packages

          generate_tbody() {
            echo "          <tbody>"
            for file in feed/Packages* feed/tailscale*; do
              [ -f "${file}" ] || continue
              fname=$(basename "${file}")
              fsize=$(du -h "${file}" | cut -f1)
              fdate=$(date -r "${file}" +"%Y-%m-%d")
              echo "                        <tr>"
              echo "                            <td><a href=\"$fname\">$fname</a></td>"
              echo "                            <td>$fsize</td>"
              echo "                            <td>$fdate</td>"
              echo "                        </tr>"
            done
            echo "          </tbody>"
          }

          generate_tbody > feed/tbody.tmp
          sed -i '/<!-- tbody-anchor -->/,/<!-- end-tbody-anchor -->/d' feed/index.html
          sed -i '/<!-- tbody-anchor -->/r feed/tbody.tmp' feed/index.html

          current_date="${{ env.BUILD_DATE }}"
          sed -i "s#<span id=\"date\"></span>#<span id=\"date\">${current_date}</span>#" feed/index.html

          version=$(echo "${{ env.RELEASE_TAG }}" | sed 's/^v//')
          sed -i "s#<span id=\"version\"></span>#<span id=\"version\">${version}</span>#" feed/index.html

          rm -f feed/tbody.tmp

      - name: Deploy to feed branch
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: feed
          publish_branch: feed
          force_orphan: true


      - name: Generate release markdown
        id: generate_release_markdown
        run: |
          # Read artifacts.json and generate markdown table
          artifacts_file="${{ env.ARTIFACT_DIR }}/artifacts.json"
          
          if [[ ! -f "${artifacts_file}" ]]; then
            echo "No artifacts.json found, skipping table generation."
            exit 1
          fi
          
          # Generate Markdown table
          owner="${{ env.REPO_SMALL_OWNER }}"
          repo="${{ env.REPO_SMALL_NAME }}"
          tag="${{ env.RELEASE_TAG }}"
          table="| Target Platform ç›®æ ‡å¹³å° | Compressed Binary å‹ç¼©äºŒè¿›åˆ¶ | Compressed IPK å‹ç¼©IPK | Normal Binary åŸå§‹äºŒè¿›åˆ¶ | Normal IPK åŸå§‹IPK |
          |----------------------|-------------------------|------------------------|---------------------|----------------|
          $(jq -r --arg owner "$owner" --arg repo "$repo" --arg tag "$tag" '
          .[] | 
          "| \(.target) | " +
          (if .binary_compressed != "" then "[\(.binary_compressed)](https://github.com/\($owner)/\($repo)/releases/download/\($tag)/\(.binary_compressed))" else "" end) + " | " +
          (if .ipk_compressed != "" then "[\(.ipk_compressed)](https://github.com/\($owner)/\($repo)/releases/download/\($tag)/\(.ipk_compressed))" else "" end) + " | " +
          (if .binary_normal != "" then "[\(.binary_normal)](https://github.com/\($owner)/\($repo)/releases/download/\($tag)/\(.binary_normal))" else "" end) + " | " +
          (if .ipk_normal != "" then "[\(.ipk_normal)](https://github.com/\($owner)/\($repo)/releases/download/\($tag)/\(.ipk_normal))" else "" end) + " |"
          ' ${artifacts_file})"

          # Print the table for debugging
          echo "$table"

          # Set release body with table included
          release_body="## ğŸš€ Smaller Tailscale / æ›´å°çš„Tailscale

          **Version ç‰ˆæœ¬** :&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ${{ env.RELEASE_TAG }}   
          **Build date æ„å»ºæ—¥æœŸ** : &nbsp;&nbsp;&nbsp;&nbsp;${{ env.BUILD_DATE }}   
          **Changelog æ›´æ–°æ—¥å¿—** : &nbsp;&nbsp;&nbsp;https://github.com/${{ env.REPO }}/releases/tag/${{ env.RELEASE_TAG }}   

          ---

          ### ğŸŒ ä¸­æ–‡è¯´æ˜
          <details>
          <summary>ç‚¹å‡»å±•å¼€</summary>
          è¿™æ˜¯ä¸€ä¸ªä¸º OpenWRT æ„å»ºçš„ Tailscale çš„æç®€ç‰ˆæœ¬ï¼Œæ—¨åœ¨æä¾›æ›´å°çš„äºŒè¿›åˆ¶æ–‡ä»¶å’Œæ›´å°‘çš„èµ„æºå ç”¨ã€‚åŒ…å«åŸºç¡€äºŒè¿›åˆ¶æ–‡ä»¶å’Œ IPK åŒ…ï¼Œé€‚ç”¨äºå¤šç§ OpenWRT ç›®æ ‡å¹³å°ã€‚

          ### ğŸ› ï¸ æ„å»ºç‰¹æ€§
          - å°† \`tailscale\` å’Œ \`tailscaled\` åˆå¹¶ä¸ºå•ä¸€äºŒè¿›åˆ¶æ–‡ä»¶ã€‚  
          - ä½¿ç”¨ \`--extra-small\` ç¼–è¯‘é€‰é¡¹ï¼Œæå¤§åœ°å‡å°‘äº†äºŒè¿›åˆ¶æ–‡ä»¶çš„ä½“ç§¯ã€‚  
          - ä½¿ç”¨ UPX å‹ç¼©æŠ€æœ¯å¯¹äºŒè¿›åˆ¶æ–‡ä»¶è¿›è¡Œå‹ç¼©ï¼ˆmips64 æ¶æ„é™¤å¤–ï¼‰ï¼Œè¿›ä¸€æ­¥é™ä½å­˜å‚¨å ç”¨ã€‚  

          ### âš ï¸ ç³»ç»Ÿéœ€æ±‚
          - **å­˜å‚¨ç©ºé—´**: UPXç‰ˆæœ¬å°äº 10MB  
          - **è¿è¡Œå†…å­˜**: å¤§çº¦ 60MB  
          - **æ³¨æ„äº‹é¡¹**: å¯èƒ½æ— æ³•åœ¨å†…å­˜å°äº 256MB çš„è®¾å¤‡ä¸Šæ­£å¸¸è¿è¡Œï¼Œè¯·è°¨æ…ä½¿ç”¨ã€‚  

          ### ğŸ“¦ å…³äºæœªå‹ç¼©ç‰ˆæœ¬
          - \`filename-normal\`: åŸå§‹æœªå‹ç¼©çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œé€‚åˆéœ€è¦å®Œæ•´åŠŸèƒ½æˆ–ä¸æ”¯æŒ UPX å‹ç¼©çš„åœºæ™¯ã€‚  
          - \`filename\`: ä½¿ç”¨ UPX å‹ç¼©åçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä½“ç§¯æ›´å°ï¼Œé€‚åˆå¤§å¤šæ•°åœºæ™¯ã€‚  

          ### ğŸ“– å¦‚ä½•ç¡®å®šç›®æ ‡å¹³å°
          åœ¨æ‚¨çš„ OpenWRT è®¾å¤‡ä¸Šè¿è¡Œä»¥ä¸‹å‘½ä»¤ä»¥ç¡®å®šæ”¯æŒçš„ç›®æ ‡å¹³å°ï¼š  
          \`\`\`bash
          opkg print-architecture
          \`\`\`  
          è¯¥å‘½ä»¤å°†åˆ—å‡ºè®¾å¤‡æ”¯æŒçš„æ¶æ„ç±»å‹ï¼ˆä¸åŒ…æ‹¬ \`all\` å’Œ \`noarch\`ï¼‰ã€‚æ ¹æ®è¾“å‡ºç»“æœé€‰æ‹©å¯¹åº”çš„æ–‡ä»¶è¿›è¡Œå®‰è£…ã€‚

          </details>

          ### ğŸŒ English Description
          <details>
          <summary>Click to expand</summary>
          This is a minimal build of Tailscale for OpenWRT, designed to provide smaller binaries and lower resource usage. It includes basic binaries and IPK packages for various OpenWRT target platforms.  

          ### ğŸ› ï¸ Build Features
          - Combined \`tailscale\` and \`tailscaled\` into a single binary.  
          - Built with the \`--extra-small\` flag to significantly reduce binary size.  
          - UPX compression applied to binaries (except for mips64 architecture) to further reduce storage usage.  

          ### âš ï¸ System Requirements
          - **Storage Space**: UPX version is less than 10MB.  
          - **RAM**: Approximately 60MB.  
          - **Note**: May not work on devices with less than 256MB of RAM. Use with caution.  

          ### ğŸ“¦ About the Uncompressed Version
          - \`filename-normal\`: Original uncompressed binary, suitable for scenarios requiring full functionality or where UPX compression is unsupported.  
          - \`filename\`: UPX-compressed binary, smaller in size, suitable for most scenarios.  

          ### ğŸ“– How to Determine the Target Platform
          Run the following command on your OpenWRT device to determine the supported target platform:  
          \`\`\`bash
          opkg print-architecture
          \`\`\`  
          This command will list the supported architecture types (excluding \`all\` and \`noarch\`). Choose the corresponding file based on the output.

          </details>

          ---
            
          > [!WARNING]  
          > å¦‚æœ \`opkg\` å®‰è£…æ˜¾ç¤ºå®‰è£…å¤±è´¥ï¼Œè¯·å…ˆé€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤æµ‹è¯•ï¼š  
          > \`\`\`bash
          > tailscale --version
          > \`\`\`  
          > å¦‚æœå‘½ä»¤æ­£ç¡®è¾“å‡ºç‰ˆæœ¬å·ï¼Œåˆ™å®‰è£…æˆåŠŸã€‚å¦åˆ™è¯·æäº¤åé¦ˆã€‚
          >  
          > If the \`opkg\` installation shows failure, please test first by running:  
          > \`\`\`bash
          > tailscale --version
          > \`\`\`  
          > If the command correctly outputs the version number, the installation is successful. Otherwise, please submit feedback.

          ---

          ### ğŸ“¥ Download Links List / ä¸‹è½½é“¾æ¥æ¸…å•
          > [!NOTE]
          > è¯·ç¡®ä¿é€‰æ‹©æ­£ç¡®çš„ç›®æ ‡å¹³å°æ¶æ„å’Œtailscaleç‰ˆæœ¬ã€‚
          > Make sure to select the correct target platform architecture and Tailscale version.
          <details>
          <summary>Click to expand  /  ç‚¹å‡»å±•å¼€</summary>

          ${table}
          
          </details>
          "

          echo "release_body<<EOF" >> $GITHUB_OUTPUT
          echo "${release_body}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: "Smaller ${{ env.SOFTWARE_NAME }} ${{ env.RELEASE_TAG }}"
          body: ${{ steps.generate_release_markdown.outputs.release_body }}
          files: |
            ${{ env.ARTIFACT_DIR }}/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


      - name: Sync to small repo
        uses: actions/github-script@v6
        with:
          script: |
            await github.rest.git.createTag({
              owner: 'GuNanOvO',
              repo: 'openwrt-tailscale',
              tag: '${{ env.RELEASE_TAG }}',
              message: 'Release ${{ env.RELEASE_TAG }}',
              object: '${{ github.sha }}',
              type: 'commit'
            })